import WebSocket from"ws";import{Observable,filter,map}from"rxjs";import{createFollowListMessage}from"../nostr-api/createFollowListMessage.js";import{createFeedMessage}from"../nostr-api/createFeedMessage.js";const MySubId="One";const createRelayObservable=ws=>new Observable(subscriber=>{ws.on("error",error=>{subscriber.error(error)});ws.on("close",function close(){subscriber.complete()});ws.on("message",function message(data){const[msgType,msgSubId,msgContent]=JSON.parse(data.toString());subscriber.next({msgType,msgSubId,msgContent})})});export const createRelayConnection=(relayEndpoint,feedSettings)=>{const ws=new WebSocket(relayEndpoint);ws.on("open",function open(){console.log("Connection Opened");ws.send(createFollowListMessage(MySubId,feedSettings.author))});const RelayObservable=createRelayObservable(ws);const FollowListObservable=RelayObservable.pipe(filter(message=>message.msgContent?.kind===3),map(message=>message.msgContent.tags.flatMap(tag=>tag[1])));const FeedObservable=RelayObservable.pipe(filter(message=>message.msgContent?.kind===1),map(message=>message.msgContent));const sendFeedMessage=authors=>{ws.send(createFeedMessage(MySubId,authors.slice(0,50)))};return{RelayObservable,FollowListObservable,FeedObservable,sendFeedMessage}};